@model VgSalud.Models.E_Honorario_Cabecera_Detalle

@{
    ViewBag.Title = "RegistrarHonorarios";
    var lista = (List<VgSalud.Models.E_Honorario_Cabecera_Detalle>)ViewBag.lista;
    var tarifario = (List<VgSalud.Models.E_Tarifario>)ViewBag.tarifario;
    var Vliquidacion = ViewBag.Liquidacion;
    var Vfechainicio = ViewBag.fechaInicio;
    var VfechaFinal = ViewBag.fechaFinal;
    var VfechaIC = ViewBag.fechaIC;
    var VfechaFC = ViewBag.fechaFC;
    var marca = "checked";

}

<div class="content-wrapper">
    <section class="content-header">
        <h1>Honorarios</h1>
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-users"></i>Honorarios</a></li>
            <li class="active">Registrar Honorarios</li>
        </ol>
    </section>

    <section class="content">

        <div class="box box-default">

            <div class="box-header with-border">
                <h3 class="box-title">Datos de Honorario</h3>
                <div class="box-tools pull-right">
                    <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                    <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-remove"></i></button>
                </div>
            </div>

            <div class="box-header">

                <div style="float:left; padding:0% 1% 0 1%">
                    <a href="~/Master/Index"><center><i class="fa fa-home" style="font-size:25px; color:#13D003;margin-left: 15px;"></i><br /><strong style="color:black;margin-left: 15px;">Home</strong></center></a>
                    <br />
                </div>
            </div>

            <div class="box-body">
                <fieldset>
                    @using (Html.BeginForm())
                    {
                        <div class="col-md-12">

                            @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                            <div class="col-md-12">
                                <div class="panel-group">

                                    <div class="panel panel-primary">

                                        <div class="panel-body">

                                            <div class="col-md-12">
                                                <div class="panel panel-default">
                                                    <div class="panel-body">
                                                        <div class="col-md-6">
                                                            <div class="col-md-4">
                                                                <label>Servicio</label>
                                                            </div>
                                                            <div class="col-md-8">
                                                                <select id="servicio" name="servicio" class="form-control select2"></select>
                                                            </div>
                                                        </div>

                                                        <div class="col-md-6">
                                                            <label class="col-md-3">Liquidar por</label>
                                                            <div class="col-md-3" id="porcentaje">
                                                                <label><input type="radio" name="TipoLiqui" id="porcen" value="1" @if (ViewBag.TipoLiqui == 1) { @marca         ; } checked>Porcentaje</label>
                                                            </div>                                                            
                                                        </div>

                                                    </div>
                                                </div>

                                            </div>



                                            <div class="col-md-12"></div>
                                            <div class="col-md-12"></div>
                                            <div class="col-md-12"></div>


                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <div class="col-md-3">
                                                        <label>Tipo Cuentas</label>
                                                    </div>
                                                    <div class="col-md-9">
                                                        <select id="Tipoc" name="TipoCuenta" class="form-control select2">
                                                            <option selected value="T">Ambos</option>
                                                            <option value="F">Facturado </option>
                                                            <option value="G">Cuentas Emitidas</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <div class="col-md-3">
                                                        <label>Tipo Pago</label>
                                                    </div>
                                                    <div class="col-md-9">
                                                        <select id="Tipop" name="TipoPago" class="form-control select2">
                                                            <option selected value="T">Ambos</option>
                                                            <option value="CONTADO">Contado</option>
                                                            <option value="CREDITO">Credito</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>


                                            <div class="col-md-12">


                                                <div class="panel panel-default">
                                                    <div class="panel-body">
                                                        <div class="col-md-6">

                                                            <div class="col-md-12">
                                                                <label class="col-md-12">Tipo Rango</label>
                                                                <div class="col-md-6">
                                                                    <div class="form-group">
                                                                        <label>
                                                                            <input type="radio" id="TipoRango" value="1" name="TipoRango"
                                                                                   @if (ViewBag.tipoRango == 1) { @marca  ; }>Fecha de Atencion
                                                                        </label>
                                                                    </div>

                                                                </div>
                                                                <div class="col-md-6">
                                                                    <div class="form-group">
                                                                        <label>
                                                                            <input type="radio" id="TipoRango" value="2" name="TipoRango"
                                                                                   @if (ViewBag.tipoRango == 2) { @marca  ; }>Fecha de Pago
                                                                        </label>
                                                                    </div>

                                                                </div>
                                                                <input type="hidden" id="TipoR" name="TipoRango" />
                                                                <input type="hidden" id="cadena" name="cadena" />
                                                            </div>

                                                            <div class="col-md-12">
                                                                <div class="form-group">
                                                                    <div class="col-md-3">
                                                                        <label>Fecha Liquidacion</label>
                                                                    </div>
                                                                    <div class="col-md-9">
                                                                        <input type="text" name="fechaLiqui" id="FechaLiquidacion" maxlength="10" class="form-control  datepicker" value="@ViewBag.fechaLiqui" />
                                                                    </div>
                                                                </div>
                                                            </div>


                                                        </div>
                                                        <div class="col-md-6">

                                                            <label class="col-md-12"></label><br />
                                                            <div class="col-md-12">
                                                                <div class="form-group">
                                                                    <div class="col-md-3">
                                                                        <label>Fecha Inicio</label>
                                                                    </div>
                                                                    <div class="col-md-9">
                                                                        <input type="text" name="fechaI" id="fechai" maxlength="10" class="form-control  datepicker" value="@ViewBag.fechaI" />
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="col-md-12">
                                                                <div class="form-group">
                                                                    <div class="col-md-3">
                                                                        <label>Fecha Final</label>
                                                                    </div>
                                                                    <div class="col-md-9">
                                                                        <input type="text" name="fechaf" id="FechaFinal" maxlength="10" class="form-control  datepicker" value="@ViewBag.fechaF" />
                                                                    </div>
                                                                </div>

                                                            </div>


                                                        </div>


                                                        <div class="col-md-offset-5">
                                                            <button class="btn btn-primary" type="submit" id="buscar" style="background-color:#13D003; border:#13D003;margin-top: 11px;">Buscar</button>
                                                        </div>
                                                    </div>
                                                </div>



                                                <div class="col-md-12"></div>
                                                <div class="col-md-12"></div>


                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>

                        </div>
                        <input type="hidden" id="cadena2" name="cadena2" />
                    }
                    <div class="col-md-12">
                        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                        <form action="../HonorariosCabeceraDetalle/RegistrarEnBD" method="post" name="formulario1" id="formulario1">

                            <div class="col-md-12"></div>
                            <div class="col-md-12"></div>
                            <div class="col-md-12">

                                @if (lista != null)
                                {
                                    int cuenta = 1;
                                    <div class="box-body">
                                        <table id="example3" class="table table-bordered table-striped">
                                            <thead>
                                                <tr>
                                                    <th>CodCuenta</th>
                                                    <th>Item</th>
                                                    <th>Documento</th>
                                                    <th>Precio</th>
                                                    <th>Porcentaje</th>
                                                    <th>Total</th>
                                                    <th>Fecha Aten.</th>
                                                    <th>Fecha Fac.</th>
                                                    <th>Tarifa</th>
                                                    <th>Cantidad</th>
                                                    <th>Turno</th>
                                                    <th><input type="checkbox" name="todos" id="todos" onclick="marcarTodos()" /></th>
                                                </tr>
                                            </thead>
                                            <tbody>

                                                @foreach (var item in lista)
                                                {
                                                    string cambiaTotal;
                                                    cambiaTotal = item.Total.ToString().Replace(",", ".");

                                                    <tr>
                                                        <td>@Html.DisplayFor(modelItem => item.CodCuenta)</td>
                                                        <td>@Html.DisplayFor(modelItem => item.ItemCita)</td>
                                                        <td>@Html.DisplayFor(modelItem => item.SerieDocumento) - @Html.DisplayFor(modelItem => item.NumDoc)</td>
                                                        <td>@Html.DisplayFor(modelItem => item.CTprecio)</td>
                                                        <td>@Html.DisplayFor(modelItem => item.PorcentajeTarifa) %</td>
                                                        <td>@Html.DisplayFor(modelItem => item.Total)</td>
                                                        <td>@Html.DisplayFor(modelItem => item.FechaAtencion)</td>
                                                        <td>@Html.DisplayFor(modelItem => item.FechaEmision)</td>
                                                        @foreach (var ta in tarifario)
                                                        {
                                                            if (ta.CodTar == item.Tarifa)
                                                            {
                                                                <td>
                                                                    @ta.DescTar
                                                                </td>
                                                            }
                                                        }
                                                        <td>@Html.DisplayFor(modelItem => item.Cantidad)</td>
                                                        <td>@Html.DisplayFor(modelItem => item.Turno)</td>
                                                        <td><input title="[Seleccionar Todo]" class="dd" type="checkbox" name="arreglo" id="marca" onclick="sumar()" value="@item.CodSede|@item.Historia|@item.CodCuenta|@item.ItemCita|@item.CodDocSerie|@item.SerieDocumento|@item.NumDoc|@item.CTprecio|@item.PorcentajeTarifa|@cambiaTotal|@item.FechaAtencion|@item.Tarifa|@item.Cantidad|@item.Turno|@item.EstadoD|@item.CodMed|@item.CodServ|@item.SecFactCaja|@item.FechaEmision|@cuenta|@item.primario" /></td>

                                                    </tr>
                                                    cuenta++;
                                                }

                                            </tbody>

                                        </table>




                                        <div id="porTurno">

                                            <div class="col-md-3" style="float:right">
                                                <div class="form-group">
                                                    <div class="col-md-5">
                                                        <label>Total Pagar (T)</label>
                                                    </div>
                                                    <div class="col-md-7">
                                                        <input type="text" name="IdDemoT" id="IdDemoT" class="form-control" readonly />
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-md-3" style="float:right">
                                                <div class="form-group">
                                                    <div class="col-md-5">
                                                        <label>Pago por turno</label>
                                                    </div>
                                                    <div class="col-md-7">
                                                        <input type="text" name="IdDemo1" id="IdDemo1" class="form-control" readonly />
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-md-3" style="float:right">
                                                <div class="form-group">
                                                    <div class="col-md-5">
                                                        <label>Cantidad Turnos</label>
                                                    </div>
                                                    <div class="col-md-7">
                                                        <input type="text" name="IdDemo" id="IdDemo" class="form-control" readonly />
                                                    </div>
                                                </div>
                                            </div>

                                        </div>

                                        <div id="porPorcentaje">

                                            <div class="col-md-3" style="float:right">
                                                <div class="form-group">
                                                    <div class="col-md-5">
                                                        <label>Total Pagar (%)</label>
                                                    </div>
                                                    <div class="col-md-7">
                                                        <input type="text" name="Total" id="SumaTotal" class="form-control" readonly />
                                                    </div>
                                                </div>

                                            </div>

                                        </div>


                                    </div>


                                    <input type="hidden" name="TipoLiquidacion" value="1" />
                                    <input type="hidden" name="CodServ" value="@ViewBag.servicio" />
                                    <input type="hidden" name="CodMed" value="@ViewBag.medico" />
                                    <input type="hidden" name="TipoPago" value="@ViewBag.tipoPago" />
                                    <input type="hidden" name="TipoDoc" value="@ViewBag.tipoCuenta" />
                                    <input type="hidden" name="TipoRango" value="@ViewBag.tipoRango" />
                                    <input type="hidden" name="comoPagar" value="@ViewBag.TipoLiqui" />

                                    <input type="hidden" name="PagaTurno" id="PagoxTurno" value="0" />
                                    <input type="hidden" name="Cantidad" id="Cant" value="0" />
                                    <input type="hidden" name="PagoTotalTurno" id="TotalTurno" value="0" />

                                    <input type="hidden" name="FechaLiquidacion" value="@ViewBag.fechaLiqui" />
                                    <input type="hidden" name="FechaInicio" value="@ViewBag.fechaI" />
                                    <input type="hidden" name="FechaFinal" value="@ViewBag.fechaF" />

                                    <div class="col-md-offset-5">
                                        <button type="submit" class="btn btn-danger" id="registrar" name="Registrar" style="background-color:#13D003; border:#13D003;">Registrar</button>
                                        <a href="#" onclick="history.back();return false" class="btn btn-info">Cancelar</a>

                                    </div>

                                }

                            </div>


                        </form>

                    </div>

                </fieldset>

            </div>






        </div>

    </section>


</div>


<script>

    function marcarTodos() {
        debugger;
        if (document.formulario1.todos.checked) {
            for (i = 0; i < document.formulario1.length; i++) {
                if ((document.formulario1.elements[i].id) == "marca") {
                    document.formulario1.elements[i].checked = true;
                }
            }
        }
        else {
            for (i = 0; i < document.formulario1.length; i++) {
                if ((document.formulario1.elements[i].id) == "marca") {
                    document.formulario1.elements[i].checked = false;

                }
            }
        }

            sumar();
    }


    function sumar() {
        
        obj = document.formulario1['arreglo'];
        totalChecks = obj.length;


        if (totalChecks == null) {
            var dame = $("#marca").val();
            valor = dame.split('|');
            $("#SumaTotal").val(parseFloat(valor[9]));

        }
        else {
            var totalSumado = 0.00;
            var indice = 0;
            for (i = 0; i < totalChecks; i++) {
                if (obj[i].checked == true) {
                    valor = obj[i].value.split('|');
                    totalSumado = totalSumado + parseFloat(valor[9]);
                    indice++;

                }
            }
            $("#SumaTotal").val(totalSumado.toFixed(2));
        }
    }




    $(document).on("ready", function () {

        var medico = "@ViewBag.medico";
        var TipoLiqui = "@ViewBag.TipoLiqui";

        if (TipoLiqui == 1) {
            $("#porPorcentaje").fadeIn();
            $("#porTurno").fadeOut();
        }

        $.get('@Url.Action("ListaServicios","HonorariosCabeceraDetalle")', {},
              function (response) {
                  var select = $("#servicio");
                  select.find('option').remove();
                  $('<option>').val("NULL").text("[NO SELECCIONADO]").appendTo(select);
                  $.each(response, function (index, value) {
                      $('<option>').val(value.CodServ).text(value.NomServ).appendTo(select).enabled;
                  });
                  $('#servicio option[value=@ViewBag.servicio]').prop('selected', 'selected').change();
              });

                


        $('#Tipoc option[value=@ViewBag.tipoCuenta]').prop('selected', 'selected').change();
        $('#Tipop option[value=@ViewBag.tipoPago]').prop('selected', 'selected').change();

    });


</script>