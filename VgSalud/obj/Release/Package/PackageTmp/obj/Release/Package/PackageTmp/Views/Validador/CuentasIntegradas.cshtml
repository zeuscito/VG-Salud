@model VgSalud.Models.E_Validador

@{
    ViewBag.Title = "CuentasIntegradas";
    var servicio = (SelectList)ViewBag.listaServicio;
    var cuenta = (List<VgSalud.Models.E_Validador>)ViewBag.cuenta;

    if (ViewBag.medico == null) { ViewBag.medico = null; }
    if (ViewBag.servicio == null) { ViewBag.servicio = null; }
    if (ViewBag.turno == null) { ViewBag.turno = ""; }
    if (ViewBag.fecha == null) { ViewBag.fecha = ""; }
    if (ViewBag.check == null) { ViewBag.check = ""; }
    if (ViewBag.itemss == null) { ViewBag.itemss = 0; }
    if (ViewBag.cuentass == null) { ViewBag.cuentass = 0; }
    var color = "#F6CECE";
}

<div class="content-wrapper">
    <section class="content-header">
        <h1>Validación de Atenciones</h1>
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-users"></i>Validacion De Atenciones</a></li>
            <li class="active">Validacion De Atenciones</li>
        </ol>
    </section>
    <section class="content">
        <div class="box box-default">
            <div class="box-header with-border">

                <div class="box-tools pull-right">
                    <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                    <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-remove"></i></button>
                </div>
            </div>

            <div class="box-header">
                <div style="float:left; padding:0% 1% 0 1%">
                    <a href="~/Master/Index"><center style="margin-left:25px;"><i class="fa fa-home" style="font-size:25px; color:#13D003"></i><br /><strong style="color:black">Home</strong></center></a>
                    <br />
                </div>
            </div>

            <form method="post" action="">

                <div class="box-body">
                    <div class="row">
                        <div class="col-md-6">

                            <fieldset>
                                <legend style="margin-left: 50px;">Filtra</legend>
                                <div class="col-md-12">
                                 
                                    <div class="col-md-3"></div>
                                    <div class="col-md-3">
                                        <div class="col-md-10">
                                            <div class="form-group">

                                                <div class="col-md-12">
                                                    <label>N° Cuenta</label>
                                                    @Html.EditorFor(model => model.cuenta, new { htmlAttributes = new { @class = "form-control" } })
                                                    @Html.ValidationMessageFor(model => model.cuenta, "", new { @class = "text-danger" })

                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-2" style="padding-left:0px;">

                                            <div class="form-group">

                                                <div class="col-md-12" style="padding-left:0px;">
                                                    <br />
                                                    <input type="hidden" name="turno" class="turno" />
                                                    <input type="hidden" name="Medico" id="medicoEnvia" class="medico" />
                                                    <input type="hidden" name="CodServ" class="servicio" />
                                                    <input type="hidden" name="Fecha" class="fecha" />
                                                    <button type="submit" name="Evento" value="1" class="btn btn-danger agregar" style="padding:8px 12px;"><i class="fa fa-search"></i></button>
                                                </div>
                                            </div>

                                        </div>

                                    </div>


                                    <div class="col-md-3">
                                        <div class="col-md-12">
                                            <br />
                                            <div class="checkbox">
                                                <input type="checkbox" name="check" id="congelar" value="1" /><strong>Congelar Datos</strong>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3"></div>
                                </div>

                                <div class="col-md-12">

                                    <div class="col-md-12">
                                        <div class="panel panel-default">
                                            <div class="panel-body">

                                                <div class="col-md-12">
                                                    <div class="col-md-6">
                                                        <div class="form-group">

                                                            <div class="col-md-12">
                                                                <label>Fecha</label>
                                                                @Html.EditorFor(model => model.Fecha, new { htmlAttributes = new { @placeholder = "[NO SELECCIONADO]", @class = "form-control datepicker", @id = "fecha" } })
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">

                                                            <div class="col-md-12">
                                                                <label>Turno</label>
                                                                <select class="form-control select2" name="turno" id="turno">
                                                                    <option value="NULL">[NO SELECCIONADO]</option>
                                                                    <option value="MAÑANA">MAÑANA</option>
                                                                    <option value="TARDE">TARDE</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>

                                                </div>

                                                <div class="col-md-12">
                                                    <div class="col-md-12">
                                                        <div class="form-group">

                                                            <div class="col-md-12">
                                                                <label>Servicio</label>
                                                                @Html.DropDownList("CodServ", servicio, "[NO SELECCIONADO]", new { @class = "form-control select2", @id = "servicio" })


                                                            </div>

                                                        </div>
                                                    </div>


                                                </div>

                                                <div class="col-md-12">
                                                    <div class="col-md-12">
                                                        <div class="form-group">

                                                            <div class="col-md-12">
                                                                <label>Medico</label>

                                                                <select class="form-control select2" id="medico" name="Medico">
                                                                    <option value="null">[NO SELECCIONADO]</option>
                                                                </select>
                                                            </div>

                                                        </div>
                                                    </div>

                                                </div>
                                            </div>


                                        </div>
                                    </div>
                          

                                </div>

                            </fieldset>

                        </div>


                        <div class="col-md-6">
                            <fieldset>
                                <legend style="margin-left: 28px;">
                                    <ol class="breadcrumb" style="margin-bottom: 0px; margin-left: 0px;padding-bottom: 0px;padding-top: 0px;margin-right: 250px;">
                                        <li>Detalle</li>
                                        <li>Paciente</li>
                                        <li style="color:coral">@ViewBag.paciente</li>
                                    </ol>
                                
                                 </legend>
                           

                                <div class="col-md-12">
                                    <br />
                                    <div class="col-md-3">
                                        <h4 id="verde" style="display:none; color:lightgreen;">SI ATENDIDO</h4>
                                        <h4 id="anaranjado" style="display:none; color:chocolate;">NO ATENDIDO</h4>
                                    </div>
                                    <div class="col-md-3">
                                        <h4>Total Cuentas</h4>
                                    </div>

                                    <div class="col-md-1">
                                        <h4>
                                            <label class="cuenta"></label>
                                            <strong></strong>

                                        </h4>
                                    </div>

                                    <div class="col-md-3">
                                        <h4>
                                            Total Atenciones
                                        </h4>
                                    </div>

                                    <div class="col-md-1">
                                        <h4>
                                            <label id="item"></label>
                                            <strong></strong>
                                        </h4>
                                    </div>

                                    <div class="col-md-1"></div>

                                </div>

                                <div class="col-md-12">
                                 
                                    <div class="col-md-12">
                                        <table id="" class="table table-bordered table-striped">
                                            <thead>
                                                <tr class="headTabla">

                                                    <th>Item</th>
                                                    <th>Tarifa</th>
                                                    <th>Descripcion</th>
                                                    <th>Cantidad</th>
                                                    <th>Precio</th>
                                                    <th>Total</th>


                                                </tr>
                                            </thead>
                                            @if (cuenta != null)
                                            {
                                                <tbody>
                                                    @foreach (var item in cuenta)
                                                    {
                                                        <tr style="background-color:@if (item.EstadoLiq == "L") { @color }">
                                                            <td>@Html.DisplayFor(modelItem => item.Item)</td>
                                                            <td>@Html.DisplayFor(modelItem => item.codtar)</td>
                                                            <td>@Html.DisplayFor(modelItem => item.DescTar)</td>
                                                            <td>@Html.DisplayFor(modelItem => item.cantidad)</td>
                                                            <td>@Html.DisplayFor(modelItem => item.precioUni)</td>
                                                            <td>@Html.DisplayFor(modelItem => item.Total)</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            }

                                        </table>
                                    </div>

                                </div>

                            </fieldset>

                        </div>

                    </div>

                    <div class="col-md-12">
                        <br /><br />
                        <div class="form-group">
                            <div class="col-md-12">
                                <center>
                                    <button type="submit" value="2" name="Evento" class="btn btn-danger" style="background-color:#13D003; border:0" id="registrar">Registrar</button>
                                </center>
                            </div>
                        </div>
                    </div>
                </div>

            </form>

        </div>
    </section>
</div>

<script>
    $(document).ready(function () {

        @if (ViewBag.Registrado == "S") {
          <text>  $("#verde").fadeIn();     </text>
        } else if (ViewBag.Registrado == "N") {
             <text>  $("#anaranjado").fadeIn();     </text>
        } else {
             <text>  $("#verde").fadeOut(); $("#anaranjado").fadeOut();  </text>
        }


        $("#registrar").click(function () {
           
            var fecha = $("#fecha").val();
            var medico = $("#medico").val();
            var turno = $("#turno").val();
            var servicio = $("#servicio").val();

            $(".fecha").val(fecha);
            $(".turno").val(turno);
            $(".medico").val(medico);
            $(".servicio").val(servicio);
        });



        @if (ViewBag.check == "1")
        {
        <text>
        $("#congelar").prop("checked", "checked");
        var med = "@ViewBag.medico";

        var servicio = "@ViewBag.servicio";
        $.get('@Url.Action("ObtenerMedico","Validador")', { servicio: servicio },
         function (response) {
             var select = $("#medico");
             select.find('option').remove();

             if (response != null) {
                 $("#select2-medico-container").text("");
                 $('<option>').val("NULL").text("[NO SELECCIONADO]").appendTo(select);
                 $.each(response, function (index, value) {
                     $('#medico option[value="NULL"]').attr("selected", true).change();
                     $('<option>').val(value.CodMed).text(value.NomMed).appendTo(select);
                     if (med == value.CodMed) {
                         $('#medico option[value=' + value.CodMed + ']').prop('selected', 'selected').change();

                     }
                 });

             } else {
                 $('<option>').val("NULL").text("[NO SELECCIONADO]").appendTo(select);
                 $('#medico option[value="NULL"]').attr("selected", true).change();
                 $("#select2-medico-container").text("");
             }
         });
        var nuevo = ("@ViewBag.turno").replace("&#209;", "Ñ");
        $('#turno option[value=' + nuevo + ']').prop('selected', 'selected');
        $('#servicio option[value=@ViewBag.servicio]').prop('selected', 'selected');

        $("#medico").attr("disabled", true);
        $("#servicio").attr("disabled", true);
        $("#turno").attr("disabled", true);
        $("#fecha").attr("disabled", true);
        </text>
              }
              else
              {
              <text>
        $("#medico").attr("disabled", false);
        $("#servicio").attr("disabled", false);
        $("#turno").attr("disabled", false);
        $("#fecha").attr("disabled", false);
        $('#servicio option[value=@ViewBag.servicio]').prop('selected', 'selected');
        $('#medico option[value=@ViewBag.medico]').prop('selected', 'selected');
        </text>
              }

        $("#congelar").change(function () {
            if (this.checked == true) {
                var fecha = $("#fecha").val();
                var medico = $("#medico").val();
                var turno = $("#turno").val();
                var servicio = $("#servicio").val();

                $(".fecha").val(fecha);
                $(".turno").val(turno);
                $(".medico").val(medico);
                $(".servicio").val(servicio);

                $("#medico").attr("disabled", true);
                $("#servicio").attr("disabled", true);
                $("#turno").attr("disabled", true);
                $("#fecha").attr("disabled", true);

            } else {

                $("#medico").attr("disabled", false);
                $("#servicio").attr("disabled", false);
                $("#turno").attr("disabled", false);
                $("#fecha").attr("disabled", false);
            }
        });

        $("#fecha").change(function () {

            var fecha = this.value;
            var servicio = $("#servicio").val();
            var medico = $("#medico").val();
            var turno = $("#turno").val();
            $.get('@Url.Action("Obteneritemcuenta", "Validador")',
                {
                    servicio: servicio,
                    fecha: fecha,
                    medico: medico,
                    turno: turno
                },
                function (response) {
                    var cuenta = 0; var items = 0;
                    if (response != false) {
                        $.each(response, function (index, value) {
                            cuenta += 1;
                            items += value.Item;
                        });
                        $(".cuenta").text(cuenta);
                        $("#item").text(items);
                    }
                    else {
                        $(".cuenta").text("0");
                        $("#item").text("0");
                    }
                });
        });

        var servicio = "@ViewBag.servicio";
        var medico = "@ViewBag.medico";
        var fecha = "@ViewBag.fecha";
        var turno = "@ViewBag.turno";

        $("#medico").change(function () {
              var medico = $("#medico").val();

            var servicio = $("#servicio").val();
            var turno = $("#turno").val();
            var fecha = $("#fecha").val();
            $.get('@Url.Action("Obteneritemcuenta", "Validador")',
            {
                servicio: servicio,
                fecha: fecha,
                medico: medico,
                turno: turno
            },
            function (response) {
                var cuenta = 0;
                var items = 0;
                if (response != false) {
                    $.each(response, function (index, value) {
                        cuenta += 1;
                        items += value.Item;
                    });

                    $(".cuenta").text(cuenta);
                    $("#item").text(items);
                }
                else {
                    $(".cuenta").text(cuenta);
                    $("#item").text(items);

                }

            });

        });

        $("#turno").change(function () {

            var servicio = $("#servicio").val();
            var turno = this.value;;
            var medico = $("#medico").val();
            var fecha = $("#fecha").val();
            $.get('@Url.Action("Obteneritemcuenta", "Validador")',
          {
              servicio: servicio,
              fecha: fecha,
              medico: medico,
              turno: turno
          },
          function (response) {
              var cuenta = 0; var items = 0;
              if (response != false) {
                  $.each(response, function (index, value) {
                      cuenta += 1;
                      items += value.Item;
                  });

                  $(".cuenta").text(cuenta);
                  $("#item").text(items);
              }
              else {
                  $(".cuenta").text("0");
                  $("#item").text("0");
              }
          });

        });


        $("#servicio").change(function () {

            var servicio = this.value;
            $.get('@Url.Action("ObtenerMedico","Validador")', { servicio: servicio },
                function (response) {
                    var select = $("#medico");
                    select.find('option').remove();

                    if (response != null) {
                        $("#select2-medico-container").text("");
                        $('<option>').val("NULL").text("[NO SELECCIONADO]").appendTo(select);
                        $.each(response, function (index, value) {
                            $('#medico option[value="NULL"]').attr("selected", true).change();
                            $('<option>').val(value.CodMed).text(value.NomMed).appendTo(select);
                        });
                    } else {
                        $('<option>').val("NULL").text("[NO SELECCIONADO]").appendTo(select);
                        $('#medico option[value="NULL"]').attr("selected", true).change();
                        $("#select2-medico-container").text("");
                    }
                });

            var medico = $("#medico").val();
            var turno = $("#turno").val();
            var fecha = $("#fecha").val();

            $.get('@Url.Action("Obteneritemcuenta", "Validador")',
           {
               servicio: servicio,
               fecha: fecha,
               medico: medico,
               turno: turno
           },
           function (response) {
               var cuenta = 0; var items = 0;
               if (response != false) {
                   $.each(response, function (index, value) {
                       cuenta += 1;
                       items += value.Item;
                   });

                   $(".cuenta").text(cuenta);
                   $("#item").text(items);
               }
               else {
                   $(".cuenta").text("0");
                   $("#item").text("0");
               }

           });

        });

        var marcado = $("#congelar").prop("checked") ? true : false;

        if (marcado == true) {
            var fecha = $("#fecha").val();
            var turno = $("#turno").val();
            var servicio = $("#servicio").val();
            var medicos = $("#medico").val();

            $(".fecha").val(fecha);
            $(".turno").val(turno);
            $(".medico").val(medicos);
            $(".servicio").val(servicio);

            $("#medico").attr("disabled", true);
            $("#servicio").attr("disabled", true);
            $("#turno").attr("disabled", true);
            $("#fecha").attr("disabled", true);
        }


        var med = "@ViewBag.medico";
        $("#medicoEnvia").val(med);

        var servicio = "@ViewBag.servicio";
        if (servicio != "") {

            $.get('@Url.Action("ObtenerMedico","Validador")', { servicio: servicio },
             function (response) {

                 var select = $("#medico");
                 select.find('option').remove();
                 $("#select2-medico-container").text("");
                 $('<option>').val("NULL").text("[NO SELECCIONADO]").appendTo(select);
                 $.each(response, function (index, value) {
                     $('<option>').val(value.CodMed).text(value.NomMed).appendTo(select);
                     if (med == value.CodMed) {
                         $('#medico option[value=' + value.CodMed + ']').prop('selected', 'selected').change();
                         $("#select2-medico-container").text(value.NomMed);
                         $("#item").text("@ViewBag.itemss");
                         $(".cuenta").text("@ViewBag.cuentass");
                     }
                 });
             });

        }

        @if (ViewBag.fecha != "")
        {
        <text>
        $("#fecha").val("@ViewBag.fecha");
        </text>
        }


        if ("@ViewBag.cuentass" != "0") {
            $(".cuenta").text("@ViewBag.cuentass");
        }
        else {
            $(".cuenta").text("0");
        }
        if ("@ViewBag.itemss" != "0") {
            $("#item").text("@ViewBag.itemss");
        } else {
            $("#item").text("0");
        }
        var nuevo = ("@ViewBag.turno").replace("&#209;", "Ñ");
        $('#turno option[value=' + nuevo + ']').prop('selected', 'selected');

        var servicio = "@ViewBag.servicio";
        var medico = "@ViewBag.medico";
        var fecha = "@ViewBag.fecha";
        var turno = "@ViewBag.turno";



    });




</script>

@*<script>

    $(document).ready(function () {

        var ALT = 18; var N = 78; var presiono2 = false;
        $(document).keydown(function (e) {
            if (e.keyCode == ALT) {
                presiono2 = true;
            }

            if (presiono2 && (e.keyCode == 123)) {
                $("#registrar").click();
            }
            else if (presiono2 && (e.keyCode == 112)) {
                $(location).attr("href", "../Master/Index");
            }
        });

        $(document).keyup(function (e) {
            if (e.keyCode == ALT) {
                presiono2 = false;
            }
        });
    });

</script>*@